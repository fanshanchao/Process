# 网站架构演变

> 本文用一个故事和图片描述了一个网站由小到大的架构演变过程。

故事从我的大学生活开始......

1. 大一的时候，为了能够遇同班的同学更好的交流学习，我使用下面的架构搭建了一个博客论坛，取名为VForum（后面简称VF）。因为用户比较少，只有本班的同学，所以网站很好的运行着。

   目前技术栈如下：

   * 应用程序：Java
   * 数据库：MySQL

![image-20201229001248039](https://fanshanchao.oss-cn-shenzhen.aliyuncs.com/img/image-20201229001248039.png)

2. 由于VF论坛的火热，其它班的同学也开始加入这个论坛，性能开始变低，且数据存储空空间不足，这个时候我就想到一个方案，那就是应用和数据分离，不再放在同一个服务器下，于是有了下面的架构。

   目前技术栈如下：

   * 应用程序：Java
   * 数据库：MySQL

![image-20201229232930974](https://fanshanchao.oss-cn-shenzhen.aliyuncs.com/img/image-20201229232930974.png)

3. 某一天我发现论坛大部分人都只看论坛的热门贴，且热门贴只占每天发帖量的20%。也就是俗称的**二八定律**：在任何一组东西中，最重要的只占其中一小部分，约20%，其余80%尽管是多数，却是次要的。我们都知道访问访问数据库的数据得到磁盘上进行获取（这里忽略数据库自带的缓存），而磁盘IO是极其耗时的操作，相对来说内存虽然空间要小很多，但是速度比磁盘快了一个数量级。所以我选择把这20%重要的数据放到内存中去，能够极大的提高热门贴的访问性能。于是有了下面的架构图。

   目前技术栈如下：

   * 应用程序：Java
   * 数据库：MySQL
   * 缓存：Redis

![image-20201229234654628](https://fanshanchao.oss-cn-shenzhen.aliyuncs.com/img/image-20201229234654628.png)

4. 使用缓存后，对数据库的大部分读操作都会走缓存，但是还是有少量的读和全部的写会到数据库。随着校内访问论坛的人越多，我的数据库有点撑不住了，有时候发个贴要几分钟才能发出去。经核查发现是数据库负载压力太大了，所以选择使用了目前主流数据库都在用的架构模式：**读写分离**。也就是用一台服务器来专门进行写操作，这叫主库。再用一台服务器专门用来进行读操作，这叫从库。主从库之间通过数据同步来保证数据的一致性，当然这是会有一定的延迟性的，对于读时效要求高的可以到主库进行读。架构演变至下图。

   目前技术栈如下：

   * 应用程序：Java
   * 数据库：MySQL
   * 缓存：Redis

   ![image-20210103233928872](https://fanshanchao.oss-cn-shenzhen.aliyuncs.com/img/image-20210103233928872.png)

5. 为了回馈大家对论坛的热情，我在周六晚上在论坛进行了一次有奖竞猜活动。但这天数据库服务器出问题了，自动宕机了，导致活动无法继续下去，只好暂停。其实这次事故是可以在服务器层面上去避免的，完全可以使用多台数据库服务器，一台服务器宕机了我就使用另外一台，这就是集群架构模式。下图的架构我对所有服务器都做了集群，极大了提高了系统的稳定性。但是这里要注意一点，数据库主库和从库都用了集群，这里主库的集群和从库的集群都 会要进行数据同步，会有延迟问题。

   目前技术栈如下：

   * 应用程序：Java
   * 数据库：MySQL
   * 缓存：Redis

   ![image-20210104000123348](https://fanshanchao.oss-cn-shenzhen.aliyuncs.com/img/image-20210104000123348.png)